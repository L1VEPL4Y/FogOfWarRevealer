<script lang="ts">
	import { onMount } from 'svelte';
  import OpenSeadragon from 'openseadragon';

    let viewer:OpenSeadragon.Viewer;
    let {styleClasses, currentMapSrc, currentMaskSrc, dmView, revealMode, revealRadius}:{styleClasses: string, currentMapSrc:string, currentMaskSrc:string, dmView:boolean, revealMode:boolean, revealRadius:number} = $props();
    let maskCanvas:HTMLCanvasElement;
    onMount(() => {
      viewer = OpenSeadragon({
        id: "openSeadragonViewer",
        prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
        //Initially load a simple full white image
        tileSources: {
          type: 'image',
          url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABgAAAANgCAYAAADqIqOWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABvySURBVHhe7dkxDQAwDMCw8ifd/mOwyD5DIbMAAAAAAEDOvAEAAAAAAPifAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABBkAAAAAAAAQZAAAAAAAAECQAQAAAAAAAEEGAAAAAAAABB3zBLp+hsBhhAAAAABJRU5ErkJggg=="
        },
        maxZoomPixelRatio: 5,
        minZoomImageRatio: 0.5
      });
      //Whenever the image is opened sucessfully overlay the mask in the 2nd OpenSeadragon Viewer Layer. Opacity depending on player/DM view
      viewer.addHandler("open", () => {
        viewer.removeOverlay(maskCanvas);
        const item = viewer.world.getItemAt(0);
        const { x: width, y: height } = item.getContentSize();

        maskCanvas = createFullMask(width, height);

        viewer.addOverlay({
          element: maskCanvas,
          location: viewer.viewport.imageToViewportRectangle(0, 0, width, height),
        });
      });
      let isDrawing = false;
      let lastPoint:OpenSeadragon.Point|null = null;

      viewer.addHandler("canvas-press", (event) => {
        if(revealMode){
          isDrawing = true;
          lastPoint = event.position;
          revealAt(lastPoint, lastPoint, viewer); // draw a dot
        }
      });

      viewer.addHandler("canvas-drag", (event) => {
        if(revealMode){
          if (!isDrawing) return;
          event.preventDefaultAction = true; // stop dragging
          if(lastPoint){
            revealAt(lastPoint, event.position, viewer);
          }
          lastPoint = event.position;
        }
      });

      viewer.addHandler("canvas-release", () => {
        if(revealMode){
          isDrawing = false;
          lastPoint = null;
        }
      });
    });
    //Whenever currentMapSrc or currentMaskSrc is updated (meaning a new map image or Mask Image has been loaded), open the image in the OpenSeadragon Viewer
    $effect(() => {
      if (viewer && currentMapSrc != ""){
          openImage(viewer);
      }
    });
    //Whenever a new Mask is loaded, draw it onto the overlaid canvas
    $effect(() => {
      //For some reason this console.log is needed. It won't run the effect when the mask is loaded otherwise.
      console.log("mask arrived in component:",currentMaskSrc);
      if(maskCanvas && currentMaskSrc != ""){
        const ctx = maskCanvas.getContext("2d");
        const img = new Image();
        img.onload = () => {
          if(ctx){
            ctx.clearRect(0,0,maskCanvas.width, maskCanvas.height);
            ctx.drawImage(img, 0, 0);
          }
        }
        img.src = currentMaskSrc;
      }
    });
    //Opens the image loaded at currentMapSrc in the OpenSeadragon Viewer
    function openImage(viewer:OpenSeadragon.Viewer){
      if(currentMapSrc != "" && viewer ){
        viewer.open({
                type: 'image',
                url: currentMapSrc
            })
      }
    }
    //Create Full Black Mask (nothing revealed for players)
    function createFullMask(width:number, height:number) {
      // Create an in-memory canvas
      const canvas = document.createElement("canvas");
      canvas.style.opacity = (dmView?0.5:1).toString();
      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext("2d");

      // Fill the entire canvas black
      if(ctx){
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, width, height);
      }
      return canvas;
    }
    //Function to reveal part of the mask
    function revealAt(from:OpenSeadragon.Point, to:OpenSeadragon.Point, viewer:OpenSeadragon.Viewer) {
      const viewportFrom = viewer.viewport.pointFromPixel(from);
      const viewportTo = viewer.viewport.pointFromPixel(to);

      const imageFrom = viewer.viewport.viewportToImageCoordinates(viewportFrom);
      const imageTo = viewer.viewport.viewportToImageCoordinates(viewportTo);

      let maskCtx = maskCanvas.getContext("2d");
      if(maskCtx){
        maskCtx.globalCompositeOperation = "destination-out";
        maskCtx.lineCap = "round";
        maskCtx.lineJoin = "round";
        maskCtx.strokeStyle = "rgba(0,0,0,1)";
        maskCtx.lineWidth = revealRadius; // brush size in pixels

        maskCtx.beginPath();
        maskCtx.moveTo(imageFrom.x, imageFrom.y);
        maskCtx.lineTo(imageTo.x, imageTo.y);
        maskCtx.stroke();
      }
    }
    
</script>
<div id="openSeadragonViewer" class={styleClasses}>

</div>
